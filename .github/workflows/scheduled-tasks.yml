name: Scheduled Tasks

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual trigger

env:
  NODE_VERSION: '20.x'

jobs:
  # Check for dependency updates
  dependency-updates:
    name: Check Dependency Updates
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Check for outdated packages
        run: |
          npm outdated || true
          echo "Run 'npm update' to update packages"
      
      - name: Create issue for major updates
        uses: actions/github-script@v7
        with:
          script: |
            const { execSync } = require('child_process');
            const outdated = execSync('npm outdated --json || true').toString();
            
            if (outdated) {
              const packages = JSON.parse(outdated);
              const majorUpdates = Object.entries(packages)
                .filter(([_, info]) => {
                  const current = info.current.split('.')[0];
                  const latest = info.latest.split('.')[0];
                  return current !== latest;
                });
              
              if (majorUpdates.length > 0) {
                const body = `## Major Dependency Updates Available\n\n` +
                  majorUpdates.map(([name, info]) => 
                    `- **${name}**: ${info.current} â†’ ${info.latest}`
                  ).join('\n');
                
                github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: 'Major dependency updates available',
                  body: body,
                  labels: ['dependencies', 'maintenance']
                });
              }
            }

  # Security audit
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Run npm audit
        run: |
          npm audit --audit-level=moderate || true
      
      - name: Create issue for vulnerabilities
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Security vulnerabilities detected',
              body: 'npm audit found security vulnerabilities. Please review and update dependencies.',
              labels: ['security', 'high-priority']
            });

  # Check AWS costs
  cost-monitoring:
    name: AWS Cost Monitoring
    runs-on: ubuntu-latest
    
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: Check AWS costs
        run: |
          echo "Checking AWS costs for the current month..."
          
          START_DATE=$(date -u -d "$(date +%Y-%m-01)" +%Y-%m-%d)
          END_DATE=$(date -u +%Y-%m-%d)
          
          COST=$(aws ce get-cost-and-usage \
            --time-period Start=$START_DATE,End=$END_DATE \
            --granularity MONTHLY \
            --metrics UnblendedCost \
            --query 'ResultsByTime[0].Total.UnblendedCost.Amount' \
            --output text)
          
          echo "Current month cost: \$$COST"
          
          # Alert if cost exceeds threshold
          THRESHOLD=500
          if (( $(echo "$COST > $THRESHOLD" | bc -l) )); then
            echo "::warning::AWS costs exceed threshold: \$$COST > \$$THRESHOLD"
          fi

  # Cleanup old artifacts
  cleanup-artifacts:
    name: Cleanup Old Artifacts
    runs-on: ubuntu-latest
    
    steps:
      - name: Delete old artifacts
        uses: actions/github-script@v7
        with:
          script: |
            const days = 30;
            const timestamp = Date.now() - (days * 24 * 60 * 60 * 1000);
            
            const artifacts = await github.rest.actions.listArtifactsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });
            
            for (const artifact of artifacts.data.artifacts) {
              if (Date.parse(artifact.created_at) < timestamp) {
                console.log(`Deleting artifact: ${artifact.name}`);
                await github.rest.actions.deleteArtifact({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  artifact_id: artifact.id
                });
              }
            }

  # Database backup verification
  backup-verification:
    name: Verify Database Backups
    runs-on: ubuntu-latest
    
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: Check DynamoDB backups
        run: |
          echo "Checking DynamoDB backup status..."
          
          # List recent backups
          aws dynamodb list-backups \
            --time-range-lower-bound $(date -u -d '7 days ago' +%s) \
            --query 'BackupSummaries[*].[BackupName,BackupStatus,BackupCreationDateTime]' \
            --output table
          
          echo "Backup verification complete"

  # Performance monitoring
  performance-check:
    name: Performance Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Run Lighthouse CI
        run: |
          npm install -g @lhci/cli
          
          # Run Lighthouse against production
          lhci autorun \
            --collect.url=https://makeriess.com \
            --collect.numberOfRuns=3 \
            --assert.preset=lighthouse:recommended \
            || true
        continue-on-error: true
